{% extends "base.html" %}
{% block title %}Local Vulnerability Scanner{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">💻 Local System Vulnerability Scanner</h3>
  <p>This scan checks OS, Firewall, CPU, Memory, Disk, Processes, Network, and Malware.</p>

  <!-- Button Row -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Run Local Scan -->
    <form method="POST">
      <button type="submit" class="btn btn-success">▶ Run Local Scan</button>
    </form>

    <!-- Run New Scan (only visible after results) -->
    {% if results %}
    <form method="POST">
      <button type="submit" class="btn btn-warning">🔄 Run New Scan</button>
    </form>
    {% endif %}
  </div>

  {% if results %}
  <hr>
  <h4 class="mt-4">📝 Detailed Report</h4>

  <!-- System Info -->
  <div class="card mt-3">
    <div class="card-header fw-bold">🖥️ System Info</div>
    <div class="card-body p-0">
      <table class="table mb-0">
        <tr><th>OS</th><td>{{ results.system_info.os }}</td></tr>
        <tr><th>Architecture</th><td>{{ results.system_info.architecture }}</td></tr>
        <tr><th>Hostname</th><td>{{ results.system_info.hostname }}</td></tr>
        <tr><th>Uptime</th><td>{{ results.system_info.uptime }}</td></tr>
      </table>
    </div>
  </div>

  <!-- Firewall -->
  <div class="card mt-3">
    <div class="card-header fw-bold">🛡️ Firewall Status</div>
    <div class="card-body">
      <span class="badge {% if results.firewall_status in ['OFF','inactive'] %}bg-danger{% else %}bg-success{% endif %}">
        {{ results.firewall_status }}
      </span>
      {% if results.firewall_status in ['OFF','inactive'] %}
        <a href="https://learn.microsoft.com/en-us/windows/security/operating-system-security/firewall" target="_blank" class="ms-2">
          👉 Click here to enable Firewall
        </a>
      {% endif %}
    </div>
  </div>

  <!-- CPU / Memory / Disk -->
  <div class="card mt-3">
    <div class="card-header fw-bold">⚡ Performance</div>
    <div class="card-body">
      <h6>CPU Usage</h6>
      <div class="progress mb-3" style="height:20px">
        <div class="progress-bar {% if results.cpu_usage > 80 %}bg-danger{% elif results.cpu_usage > 50 %}bg-warning{% else %}bg-success{% endif %}" 
             role="progressbar" style="width: {{ results.cpu_usage }}%">
          {{ results.cpu_usage }}%
        </div>
      </div>

      <h6>Memory</h6>
      <table class="table table-sm">
        {% for key, value in results.memory.items() %}
        <tr><th>{{ key }}</th><td>{{ value }}</td></tr>
        {% endfor %}
      </table>

      <h6>Disk</h6>
      <div class="progress mb-2" style="height:20px">
        <div class="progress-bar {% if results.disk.percent > 90 %}bg-danger{% elif results.disk.percent > 70 %}bg-warning{% else %}bg-success{% endif %}"
             role="progressbar" style="width: {{ results.disk.percent }}%">
          {{ results.disk.percent }}%
        </div>
      </div>
      <table class="table table-sm">
        {% for key, value in results.disk.items() %}
        <tr><th>{{ key }}</th><td>{{ value }}</td></tr>
        {% endfor %}
      </table>
    </div>
  </div>

  <!-- Processes -->
  <div class="card mt-3">
    <div class="card-header fw-bold">📋 Processes (Suspicious marked)</div>
    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
      <table class="table table-bordered table-hover table-sm">
        <thead class="table-light">
          <tr>
            <th>PID</th>
            <th>Name</th>
            <th>User</th>
            <th>CPU %</th>
            <th>Memory %</th>
            <th>Suspicious</th>
          </tr>
        </thead>
        <tbody>
          {% for p in results.running_processes %}
          <tr class="{% if p.suspicious %}table-danger{% endif %}">
            <td>{{ p.pid }}</td>
            <td>{{ p.name if p.name else '—' }}</td>
            <td>{{ p.username if p.username else '—' }}</td>
            <td>{{ "%.2f"|format(p.cpu_percent) }}</td>
            <td>{{ "%.2f"|format(p.memory_percent) }}</td>
            <td>
              {% if p.suspicious %}⚠️ Yes{% else %}✅ No{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Network -->
  <div class="card mt-3">
    <div class="card-header fw-bold">🌐 Network Connections</div>
    <div class="card-body" style="max-height: 250px; overflow-y: auto;">
      <table class="table table-striped table-sm">
        <thead class="table-light">
          <tr>
            <th>PID</th>
            <th>Local Address</th>
            <th>Remote Address</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for c in results.network_connections %}
          <tr>
            <td>{{ c.pid }}</td>
            <td>{{ c.laddr }}</td>
            <td>{{ c.raddr if c.raddr else "—" }}</td>
            <td>{{ c.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Malware -->
  <div class="card mt-3">
    <div class="card-header fw-bold">🦠 Malware Check</div>
    <div class="card-body">
      <table class="table table-bordered">
        <tr><th>VirusTotal</th><td>{{ results.virustotal_check }}</td></tr>
        <tr>
          <th>Local Malware Scan</th>
          <td>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#malwareOutput">
              Show/Hide Details
            </button>
            <div class="collapse mt-2" id="malwareOutput">
              <pre class="m-0">{{ results.local_malware_scan }}</pre>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <!-- Report Download -->
  <div class="mt-4 text-center">
    <a href="{{ url_for('download_report') }}" class="btn btn-primary">
      📥 Download Report
    </a>
  </div>

  {% endif %}
</div>
{% endblock %}
